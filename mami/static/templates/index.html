<%inherit file="base.html"/>


  <div class="container">
    <span id="is-mobile"><!-- determining resolution in css --></span>

    <div class="row loffset6 roffset6">
      <div class="col-xs-2 voffset16">
        <div>
          <img src="static/images/logo.png" width="30">
        </div>
        <div class="row loffset6">
          <h6><small>${cpright}</small></h6>
        </div>
      </div>
      <div class="col-xs-10">
        <div class="row loffset6">
          <h2>${title}</h2>
        </div>
      </div>
    </div>

    <div class="row text-center">
      <div class="col-xs-12">
        <div id="homepage_message"><b><code style="background:white">${homepage_message}</code></b></div>
      </div>
    </div>				

    <div class="row loffset6 roffset6">
      <div class="col-xs-12 voffset16">
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
          <li class="nav-item">
            <a class="nav-link" id="pills-about-tab" data-toggle="pill" href="#pills-about" role="tab" aria-controls="pills-about" aria-selected="false">${about_tab}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-map-tab" data-toggle="pill" href="#pills-map" role="tab" aria-controls="pills-map" aria-selected="false">${mill_map_tab}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-link-tab" data-toggle="pill" href="#pills-link" role="tab" aria-controls="pills-link" aria-selected="false">${link_model_tab}</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <hr>
      </div>
    </div>

    <div class="tab-content" id="pills-tabContent">
      
      <div class="tab-pane fade" id="pills-about" role="tabpanel" aria-labelledby="pills-about-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div id="about">${home_text}</div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade active" id="pills-map" role="tabpanel" aria-labelledby="pills-map-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div id="map"></div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-link" role="tabpanel" aria-labelledby="pills-link-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div>
              <h3>${link_steps}</h4>
            </div>
            <table class="table table-bordered">
              <thead>
                <tr>
                  <th scope="col">
                    ${step_1_select_mill}
                  </th>
                  <th scope="col">
                    ${step_2_select_model}
                    <input id="refreshModelList" type="button" onclick="refreshModelList();" value="${refresh_model_list}"/>
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><div id="roleModelData">${waiting}</div></td>
                  <td>
                    <div id="modelList">${waiting}</div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <hr>
      </div>
    </div>
    
    <div class="row loffset6 roffset6">
      <div class="col-xs-5">
        <span>${donation}
          <img src="/static/images/epc-qr.eu_donation_2euro_site_developer.png" height="100">
        </span>
      </div>
      <div class="col-xs-7">
        <select id="languagechoice" class="form-control">${language_options}</select>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <div style="font-size:10px;">
          ${disclaimer}
        </div>
      </div>
    </div>

    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

    <div id="modelSelection"><!--placeholder for iframe--></div>

  </div>

  <script>
  $( document ).ready(function() {      
    isMobile = false;  // global variable
    if( $('#is-mobile').css('display')=='none') {
        isMobile = true;  
    }
    
    // make sure the map is displayed, even with the class fade
    $('#pills-map-tab').parent().off('mouseup').on('mouseup', function () {
        $('canvas').css({'display': 'inline'});
    })
  });
  </script>

  <%include file="mami/map.html"/>

  <%include file="mami/features.html"/>

  <%include file="mami/popup.html"/>

  <%include file="mami/connectModel.html"/>

<script>
function selectTab(tabId) {
  // default tab
  $(tabId).trigger('click');
}

function showRoleModelList() {
  // show all available rolemodels (=mills)
  var roleModelTable = '';

  roleModelTable += '<table class="table">';
  roleModelTable += '<thead>';
  roleModelTable += '    <tr>';
  roleModelTable += '      <th scope="col">${table_model_name}</th>';
  roleModelTable += '      <th scope="col">${table_ends}</th>';
  roleModelTable += '    </tr>';
  roleModelTable += '  </thead>';
  roleModelTable += '<tbody>';
  $.each(${all_mills}, function(id, property) {
    var selectable = '';
    if (property['mac_address'] != '') {
      selectable = 'rolemodel selectable';

      roleModelTable += '  <tr';

      if (selectable != '') {
        roleModelTable += " onclick='setSelectedRoleModel(" + JSON.stringify(id) + "," + JSON.stringify(property) + ");'";
      }

      roleModelTable += '>';

      roleModelTable += '    <td>';
      roleModelTable += '<div id="nameRoleModel_';
      roleModelTable += id;
      roleModelTable += '" class="';
      roleModelTable += selectable;
      roleModelTable += '">';
      roleModelTable += property['name'];
      roleModelTable += '</div>';
      roleModelTable += '    </td>';
      
      roleModelTable += '    <td>';
      roleModelTable += '<div id="cpmRoleModel_';
      roleModelTable += id;
      roleModelTable += '" class="';
      //roleModelTable += selectable;
      roleModelTable += '">';
      roleModelTable += '</div>';
      roleModelTable += '    </td>';

      roleModelTable += '  </tr>';
    }
  });
  roleModelTable += '  </tbody>';
  roleModelTable += '</table>';


  $('#roleModelData').html(roleModelTable);
}

function showRoleModelListData() {
  $.each(millData, function(id, property) {
    $('#cpmRoleModel_' + id).html(property['cpm']);
  });
}

function refresh() {
    // set cpm in all features
    senderData = {};
    for (var i=0; i < Object.keys(data).length; i++) {
      for (const [key, value] of Object.entries(data[i])) {
        senderData[key] = value;
      }
    }
    $.each(featureSource.getFeatures(), function(index, feature) {
      var featureId = feature.getId();
      var featureData = senderData[featureId];

        perMillData = {};  // data per mill
        if (featureData !== undefined) {
          feature.set("name", featureData["name"]);
          feature.set("cpm", featureData["cpm"]);
          feature.set("message", featureData["message"]);
          
          perMillData["id"] = featureId;
          perMillData["name"] = featureData["name"];
          perMillData["cpm"] = featureData["cpm"];
          perMillData["message"] = featureData["message"];
          millData[featureId] = perMillData;
        }
    });
    molenLayer.setSource(featureSource);
    molenLayer.setStyle(styleFunction);
    
    showRoleModelListData();
}

// start sse functions
function getDataSse() {
	try {
		dataSource.close();
	}
	catch(err) {
		console.log('info: ' + err.message);
	}

	try {
		dataSource = new EventSource("getDataSse/");
	    dataSource.onmessage = function(event) {
        	data = JSON.parse(event.data);
          if (Object.keys(data).length == 0) {
            // cleanup table
            millData = {};
          }
       	  refresh();
	    }
	}
	catch (err) {
		console.log(err.message);
	}
}

/* requests the getFeatureDataSse for the selected feature from this server */
/* TODO: is to be used by step 3. the model */
/* TODO: is also used by the popup */
function getUpdates(featureId) {
	// selectedId = featureId
	try {
		singleSource.close();
	}
	catch(err) {
		console.log(err.message);
	}
	try {
	    singleSource = new EventSource("getFeatureDataSse/?feature_id=" + featureId);
	    singleSource.onmessage = function(event) {
	        /* for popup: put it on a document.element.id*/
          /* TODO: event.data is a list of dicts, for each sender a dict is available */
          $('#' + featureId).html(event.data + "<br>");
	        //event.data = cpm
	    };
	}
	catch(err) {
		console.log(err.message);
	}
}

// end sse functions

// global variables
var storedLogitude = 4.34;
var storedLattitude = 52.0;
var storedZoom = 7;

var cpm = '';
var selectedId = ''; //'nl_03503';
var data;            // contains a list of featureId's and cpm's
var senderData;      // contains featureId and cpm
var dataSource;      // contains the sse datasource which are all features
var singleSource;    // contains the selected source which is a single feature
var millData = {};   // contains a table with mill data
var models = {};     // contains a table with model data
var isMobile = false;// used for presentation mobile/screen
var roleModelSelectedId = "";    // contains id of selected roleModel
var roleModelSelectedName = "";  // contains name of selected roleModel
var modelSelectedId = "";        // contains id of selected model
var modelSelectedUrl = "";       // contains url of selected model

var featureSource = new ol.source.Vector({
    url: "static/data/features.json",
    format: new ol.format.GeoJSON(),
    useSpatialIndex: false
});

// start language choice
$('#languagechoice').off('change').on('change', function(event){
		var choice = $('#languagechoice').val();
		var newLocation = window.location.href;
		questionLocation = newLocation.indexOf("?");
		if (questionLocation > -1) {
			newLocation = newLocation.split("?")[0];
		}
		newLocation = newLocation + "?lang=" + choice;
		window.location.href = newLocation;
});
// end language choice

// start roleModel selection
function setSelectedRoleModel(id, property) {
    // start from popup.html
    if (!$('#pill-link-tab').parent().active) {
      selectTab('#pills-link-tab');
    }
    // end start from popup.html
    roleModelSelectedId = id;
    roleModelSelectedName = property["name"];
    $('.rolemodel').removeClass().addClass('rolemodel selectable');
    $('#nameRoleModel_' + id).removeClass('selectable');
    $('#nameRoleModel_' + id).addClass('selected-rolemodel');
    $('#cpmRoleModel_' + id).removeClass('selectable');

    $('.model').removeClass().addClass('model selectable');
}
// end roleModel selection

// start roleModelList using features
showRoleModelList();
// end roleModelList using features

// start get data
getDataSse();
// end get data

// start show tab-map
selectTab('#pills-map-tab');
// end show tab-map

// start get model list
refreshModelList();
// end get model list
</script>