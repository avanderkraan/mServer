<%inherit file="base.html"/>


  <div class="container">
    <span id="is-mobile"><!-- determining resolution in css --></span>

    <div class="row loffset6 roffset6">
      <div class="col-xs-2 voffset16">
        <div>
          <a href="/">
            <img id="logo" src="static/images/logo.png" width="30"/>
          </a>
        </div>
        <div class="row loffset6">
          <h6><small>${cpright}</small></h6>
        </div>
      </div>
      <div class="col-xs-10">
        <div class="row loffset6">
          <h2>${title}</h2>
        </div>
      </div>
    </div>

    <div class="row text-center">
      <div class="col-xs-12">
        <div id="homepage_message"><b><code style="background:white">${homepage_message}</code></b></div>
      </div>
    </div>				

    <div class="row loffset6 roffset6">
      <div class="col-xs-12 voffset16">
        <ul class="nav nav-pills" id="pills-tab" role="tablist">
          <li class="nav-item">
            <a class="nav-link" id="pills-about-tab" data-toggle="pill" href="#pills-about" role="tab" aria-controls="pills-about" aria-selected="false">${about_tab}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-map-tab" data-toggle="pill" href="#pills-map" role="tab" aria-controls="pills-map" aria-selected="false">${mill_map_tab}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-table-tab" data-toggle="pill" href="#pills-table" role="tab" aria-controls="pills-table" aria-selected="false">${mill_table_map}</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" id="pills-link-tab" data-toggle="pill" href="#pills-link" role="tab" aria-controls="pills-link" aria-selected="false">${link_model_tab}</a>
          </li>
        </ul>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <hr>
      </div>
    </div>

    <div class="tab-content" id="pills-tabContent">
      
      <div class="tab-pane fade" id="pills-about" role="tabpanel" aria-labelledby="pills-about-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div id="about">${home_text}</div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade active" id="pills-map" role="tabpanel" aria-labelledby="pills-map-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div id="map"></div>
            <div id="rpmEnds_map" style="cursor:pointer;" onclick="toggleUnit();"></div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade active" id="pills-table" role="tabpanel" aria-labelledby="pills-table-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div id="roleModelData">${waiting}</div>
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="pills-link" role="tabpanel" aria-labelledby="pills-link-tab">
        <div class="row loffset6 roffset6">
          <div class="col-xs-12">
            <div>
              ${link_steps}
              <br>
              ${link_model_explanation}
            </div>

            <input id="refreshModelList" type="button" onclick="refreshModelList();" value="${refresh_model_list}"/>
<!--
            <span id="modelSearchTime_less" class="glyphicon glyphicon-minus"></span>
            &nbsp;&nbsp;
            <span id="modelSearchTime">{Zoektijd}</span>
            &nbsp;&nbsp;
            <span id="modelSearchTime_more" class="glyphicon glyphicon-plus"></span>

-->
            <br>
            <span id="modelList"></span><span id="modelListPercentage"></span>

          </div>
        </div>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <hr>
      </div>
    </div>
    
    <div class="row loffset6 roffset6">
      <div class="col-xs-5">
        <!--
        <span>${donation}
          <img src="/static/images/epc-qr.eu_donation_2euro_site_developer.png" height="100">
        </span>
        -->
      </div>
      <div class="col-xs-7">
        <select id="languagechoice" class="form-control">${language_options}</select>
      </div>
    </div>

    <div class="row loffset6 roffset6">
      <div class="col-xs-12">
        <div style="font-size:10px;">
          ${disclaimer}
        </div>
      </div>
    </div>

    <div id="popup" class="ol-popup">
      <a href="#" id="popup-closer" class="ol-popup-closer"></a>
      <div id="popup-content"></div>
    </div>

    <div id="modelSelection"><!--placeholder for iframe--></div>

  </div>

  <script>
  $( document ).ready(function() {      
    isMobile = false;  // global variable
    if( $('#is-mobile').css('display')=='none') {
        isMobile = true;  
    }

    // make sure the map is displayed, even with the class fade
    $('#pills-map-tab').parent().off('mouseup').on('mouseup', function () {
        $('canvas').css({'display': 'inline'});
    })

    // start show tab-map
    selectTab('#pills-map-tab');
    //selectTab('#pills-table-tab');
    // end show tab-map

    // start get data
    get_data_via_sse();
    // end get data

    // start roleModelList using features
    showRoleModelList();
    // end roleModelList using features

    // start get model list
    // remarked to save time and network traffic while searching for models
    //refreshModelList();
    // end get model list

    // listen to click events for setModelIPSearchTimeout
    //setModelIPSearchTimeout();

    unit = getStored("unit") || toggleUnit();
    showUnit();


  });
  </script>

  <%include file="mami/map.html"/>

  <%include file="mami/features.html"/>

  <%include file="mami/popup.html"/>

  <%include file="mami/rolemodel.html"/>

  <%include file="mami/model.html"/>

  <%include file="mami/connectModel.html"/>

<script>
function selectTab(tabId) {
  // default tab
  $(tabId).trigger('click');
}

function refresh() {
    // set bpm in all features
    senderData = {};
    for (var i=0; i < Object.keys(data).length; i++) {
      for (const [key, value] of Object.entries(data[i])) {
        senderData[key] = value;
      }
    }
    $.each(featureSource.getFeatures(), function(index, feature) {
      var featureId = feature.getId();
      var featureData = senderData[featureId];

        perMillData = {};  // data per mill
        if (featureData !== undefined) {
          feature.set("name", featureData["name"]);
          feature.set("rph", featureData["rph"]);
          feature.set("blades", featureData["blades"]);
          //feature.set("message", featureData["message"]);
          
          perMillData["id"] = featureId;
          perMillData["name"] = featureData["name"];
          //perMillData["bpm"] = featureData["bpm"];
          perMillData["rph"] = featureData["rph"]
          perMillData["blades"] = featureData["blades"]
          //perMillData["message"] = featureData["message"];
          millData[featureId] = perMillData;
        }
    });
    molenLayer.setSource(featureSource);
    molenLayer.setStyle(styleFunction);
    
    showRoleModelListData();
}

// start sse functions
function get_data_via_sse() {
	try {
		dataSource.close();
	}
	catch(err) {
		console.log('info: ' + err.message);
	}

	try {
		dataSource = new EventSource("get_data_via_sse/");
	    dataSource.onmessage = function(event) {
        	data = JSON.parse(event.data);
          if (Object.keys(data).length == 0) {
            // cleanup table
            millData = {};
          }
       	  refresh();
          if (unit == "rpm") {
            $("#rpmEnds_map").html("${unit_text}<br/>${table_rpm}").css("pointer-events","auto");;
          }
          if (unit == "end") {
            $("#rpmEnds_map").html("${unit_text}<br/>${table_ends}").css("pointer-events","auto");;
          }
	    }
	}
	catch (err) {
		console.log(err.message);
	}
}
// end sse functions

// global variables
var storedLongitude = 4.34;
var storedLattitude = 52.0;
var storedZoom = 7;

var unit = '';       // contains the unit ('end' or 'rpm')
var selectedId = ''; //'nl_03503';
var data;            // contains a list of featureId's and bpm's
var senderData;      // contains featureId and bpm
var dataSource;      // contains the sse datasource which are all features
var singleSource;    // contains the selected source which is a single feature
var millData = {};   // contains a table with mill data
var models = {};     // contains a table with model data
var modelIPs = {};   // contains a table with model ip addresses, given by the user   
var checkIPs = {};   // contains the checked ips
var mySetTimeout = {};       // contains the setTimeout object while checking IPs
var searchIPTimeout = 400;   // starting searchTimeout in milliseconds for finding IPs

var modelAndSavedRoleModel = {}; // contains the model as key and the saved roleModel id as value
var modelMDNSSearchTimeout = 1000; // timeout for searching using mDNS in milliseconds
var isMobile = false;// used for presentation mobile/screen

var maxIndependentSpeedInRPM = 60; // arbitrary max speed in revolutions per minute
var independentSpeed = {};         // contains the speed per modelName for a stand alone model
var allMills = ${all_mills};       // contains all mills from the features
var filteredMillsList = {};        // contains mills after a search entry

var featureSource = new ol.source.Vector({
    url: "static/data/features.json",
    format: new ol.format.GeoJSON(),
    useSpatialIndex: false
});

function store(key, value) {
  if (typeof(Storage) !== "undefined") {
    localStorage.setItem(key, value);
  } else {
    // Sorry! No Web Storage support..
  }
}

function getStored(key) {
  if (typeof(Storage) !== "undefined") {
    return localStorage.getItem(key);
  } else {
    // Sorry! No Web Storage support..
  }
} 

store("Longitude", storedLongitude);
store("Lattitude", storedLattitude);
store("Zoom", storedZoom);

// start language choice
$('#languagechoice').off('change').on('change', function(event){
		var choice = $('#languagechoice').val();
		var newLocation = window.location.href;
		questionLocation = newLocation.indexOf("?");
		if (questionLocation > -1) {
			newLocation = newLocation.split("?")[0];
		}
		newLocation = newLocation + "?lang=" + choice;
		window.location.href = newLocation;
});
// end language choice

/*
function showModelTimeoutHTML() {
  var showTimeoutInSeconds = Math.round(modelIPSearchTimeout / 1000);

  if (isNaN(showTimeoutInSeconds)) {
    modelIPSearchTimeout = 2000;
    showTimeoutInSeconds = 2;
  }
  $("#modelSearchTime").html("{zoektijd} " + showTimeoutInSeconds.toString());
}

// start set search timeout
function setModelIPSearchTimeout() {
  $('#modelSearchTime_more').off('click').on('click', function() {
    modelIPSearchTimeout += 1000;
    if (modelIPSearchTimeout > 10000) {
      modelIPSearchTimeout = 10000;
    }
    showModelTimeoutHTML();
  });
  $('#modelSearchTime_less').off('click').on('click', function() {
    modelIPSearchTimeout -= 1000;
    if (modelIPSearchTimeout < 1000) {
      modelIPSearchTimeout = 1000;
    }
    showModelTimeoutHTML();
  });
}
// end set search timeout
*/

</script>